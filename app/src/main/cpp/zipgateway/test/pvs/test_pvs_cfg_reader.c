/* © 2014 Sigma Designs, Inc. This is an unpublished work protected by Sigma
 * Designs, Inc. as a trade secret, and is not to be used or disclosed except as
 * provided Z-Wave Controller Development Kit Limited License Agreement. All
 * rights reserved.
 *
 * Notice: All information contained herein is confidential and/or proprietary to
 * Sigma Designs and may be covered by U.S. and Foreign Patents, patents in
 * process, and are protected by trade secret or copyright law. Dissemination or
 * reproduction of the source code contained herein is expressly forbidden to
 * anyone except Licensees of Sigma Designs  who have executed a Sigma Designs’
 * Z-WAVE CONTROLLER DEVELOPMENT KIT LIMITED LICENSE AGREEMENT. The copyright
 * notice above is not evidence of any actual or intended publication of the
 * source code. THE RECEIPT OR POSSESSION OF  THIS SOURCE CODE AND/OR RELATED
 * INFORMATION DOES NOT CONVEY OR IMPLY ANY RIGHTS  TO REPRODUCE, DISCLOSE OR
 * DISTRIBUTE ITS CONTENTS, OR TO MANUFACTURE, USE, OR SELL A PRODUCT THAT IT  MAY
 * DESCRIBE.
 *
 * THE SIGMA PROGRAM AND ANY RELATED DOCUMENTATION OR TOOLS IS PROVIDED TO COMPANY
 * "AS IS" AND "WITH ALL FAULTS", WITHOUT WARRANTY OF ANY KIND FROM SIGMA. COMPANY
 * ASSUMES ALL RISKS THAT LICENSED MATERIALS ARE SUITABLE OR ACCURATE FOR
 * COMPANY’S NEEDS AND COMPANY’S USE OF THE SIGMA PROGRAM IS AT COMPANY’S
 * OWN DISCRETION AND RISK. SIGMA DOES NOT GUARANTEE THAT THE USE OF THE SIGMA
 * PROGRAM IN A THIRD PARTY SERVICE ENVIRONMENT OR CLOUD SERVICES ENVIRONMENT WILL
 * BE: (A) PERFORMED ERROR-FREE OR UNINTERRUPTED; (B) THAT SIGMA WILL CORRECT ANY
 * THIRD PARTY SERVICE ENVIRONMENT OR CLOUD SERVICE ENVIRONMENT ERRORS; (C) THE
 * THIRD PARTY SERVICE ENVIRONMENT OR CLOUD SERVICE ENVIRONMENT WILL OPERATE IN
 * COMBINATION WITH COMPANY’S CONTENT OR COMPANY APPLICATIONS THAT UTILIZE THE
 * SIGMA PROGRAM; (D) OR WITH ANY OTHER HARDWARE, SOFTWARE, SYSTEMS, SERVICES OR
 * DATA NOT PROVIDED BY SIGMA. COMPANY ACKNOWLEDGES THAT SIGMA DOES NOT CONTROL
 * THE TRANSFER OF DATA OVER COMMUNICATIONS FACILITIES, INCLUDING THE INTERNET,
 * AND THAT THE SERVICES MAY BE SUBJECT TO LIMITATIONS, DELAYS, AND OTHER PROBLEMS
 * INHERENT IN THE USE OF SUCH COMMUNICATIONS FACILITIES. SIGMA IS NOT RESPONSIBLE
 * FOR ANY DELAYS, DELIVERY FAILURES, OR OTHER DAMAGE RESULTING FROM SUCH ISSUES.
 * SIGMA IS NOT RESPONSIBLE FOR ANY ISSUES RELATED TO THE PERFORMANCE, OPERATION
 * OR SECURITY OF THE THIRD PARTY SERVICE ENVIRONMENT OR CLOUD SERVICES
 * ENVIRONMENT THAT ARISE FROM COMPANY CONTENT, COMPANY APPLICATIONS OR THIRD
 * PARTY CONTENT. SIGMA DOES NOT MAKE ANY REPRESENTATION OR WARRANTY REGARDING THE
 * RELIABILITY, ACCURACY, COMPLETENESS, CORRECTNESS, OR USEFULNESS OF THIRD PARTY
 * CONTENT OR SERVICE OR THE SIGMA PROGRAM, AND DISCLAIMS ALL LIABILITIES ARISING
 * FROM OR RELATED TO THE SIGMA PROGRAM OR THIRD PARTY CONTENT OR SERVICES. TO THE
 * EXTENT NOT PROHIBITED BY LAW, THESE WARRANTIES ARE EXCLUSIVE. SIGMA OFFERS NO
 * WARRANTY OF NON-INFRINGEMENT, TITLE, OR QUIET ENJOYMENT. NEITHER SIGMA NOR ITS
 * SUPPLIERS OR LICENSORS SHALL BE LIABLE FOR ANY INDIRECT, SPECIAL, INCIDENTAL OR
 * CONSEQUENTIAL DAMAGES OR LOSS (INCLUDING DAMAGES FOR LOSS OF BUSINESS, LOSS OF
 * PROFITS, OR THE LIKE), ARISING OUT OF THIS AGREEMENT WHETHER BASED ON BREACH OF
 * CONTRACT, INTELLECTUAL PROPERTY INFRINGEMENT, TORT (INCLUDING NEGLIGENCE),
 * STRICT LIABILITY, PRODUCT LIABILITY OR OTHERWISE, EVEN IF SIGMA OR ITS
 * REPRESENTATIVES HAVE BEEN ADVISED OF OR OTHERWISE SHOULD KNOW ABOUT THE
 * POSSIBILITY OF SUCH DAMAGES. THERE ARE NO OTHER EXPRESS OR IMPLIED WARRANTIES
 * OR CONDITIONS INCLUDING FOR SOFTWARE, HARDWARE, SYSTEMS, NETWORKS OR
 * ENVIRONMENTS OR FOR MERCHANTABILITY, NONINFRINGEMENT, SATISFACTORY QUALITY AND
 * FITNESS FOR A PARTICULAR PURPOSE.
 *
 * The Sigma Program  is not fault-tolerant and is not designed, manufactured or
 * intended for use or resale as on-line control equipment in hazardous
 * environments requiring fail-safe performance, such as in the operation of
 * nuclear facilities, aircraft navigation or communication systems, air traffic
 * control, direct life support machines, or weapons systems, in which the failure
 * of the Sigma Program, or Company Applications created using the Sigma Program,
 * could lead directly to death, personal injury, or severe physical or
 * environmental damage ("High Risk Activities").  Sigma and its suppliers
 * specifically disclaim any express or implied warranty of fitness for High Risk
 * Activities.Without limiting Sigma’s obligation of confidentiality as further
 * described in the Z-Wave Controller Development Kit Limited License Agreement,
 * Sigma has no obligation to establish and maintain a data privacy and
 * information security program with regard to Company’s use of any Third Party
 * Service Environment or Cloud Service Environment. For the avoidance of doubt,
 * Sigma shall not be responsible for physical, technical, security,
 * administrative, and/or organizational safeguards that are designed to ensure
 * the security and confidentiality of the Company Content or Company Application
 * in any Third Party Service Environment or Cloud Service Environment that
 * Company chooses to utilize.
 */

#include <string.h>
#include "test_helpers.h"
#include "provisioning_list.h"
#include "provisioning_list_files.h"
#include "pvs_cfg.h"
#include "pvs_cfg_test_help.h"

/**
\ingroup pvs_test

Text file reader, Test Plan



Error cases:

- No such file
- File not readable
- garbage at the beginning
- garbage at the end
- garbage at random places


Keyword typos
- Header error
- Device
- mode
- tlv
- type

Device errors

DSK errors
- repeated dsks
- QR too short
- QR too long
- QR number too large
- invalid characters (O, A)

hex errors
- odd number of digits
- missing 0x
- too short
- too long, decimal digits only
- too long, hex digits

mode errors

Tlv errors
- repeated tlvs
- type errors
- type 256
- 256 tlvs
- 256 characters in utf string
- 256 characters in hex
- empty hex
- quote in utf
- newline in utf
- random hex in utf
- Danish characters in utf
- 你好 (ni hao, I hope)
你好
*/

/*
Read in all the happy cases from the happy-case file
Starting import.
Created device   1 (0x3039ffff000018d23039ffff000018d2).
Created device   2 (0xa0450102feff67987f69024ad7be8798).
Created device   3 (0xa0450102feff6798b0450652feff6798).
Created device   4 (0xdd45fc2b271085abdc7dfbc728a08673).
Created device   5 (0x00057eb3d66a878327117eb3d66a8783).
Created device   6 (0x00067eb3d66a878327117eb3d66a8783).
Failed to add device 7.  DSK overlap or memory shortage.
Created device   8 (0x00087eb3d66b878300077eb3d66a8783).
Created device   9 (0x03197eb3d66a878303157eb3d66a8783).
Created device  10 (0xdb4dfc2b271085ab3039ffff000018d2).
Created device  11 (0x00027eb3d66a87833039ffff000018d2).
Created device  12 (0x00037eb3d66a87833039ffff000018d2).
Created device  13 (0x06dea0450102feff6798f78a9bd7c018).
Created device  14 (0x000e7eb3d66b87833039ffff000018d2).
Created device  15 (0x030c7eb3d66a87833039ffff000018d2).
Created 14 devices
Stopping with code 0
Provisioning list contents:
-----------------------------------
Item 0:
dsk: 0x, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2
-----------------------------------
Item 1:
dsk: 0x, 0xA0, 0x45, 0x01, 0x02, 0xFE, 0xFF, 0x67, 0x98, 0x7F, 0x69, 0x02, 0x4A, 0xD7, 0xBE, 0x87, 0x98
type: PVS_TLV_TYPE_NAME (101), len: 11, val: 0x, 0x6c, 0x6f, 0x66, 0x74, 0x73, 0x6c, 0x61, 0x6d, 0x70, 0x65, 0x00(loftslampe)
type: PVS_TLV_TYPE_LOCATION (100), len: 14, val: 0x, 0x73, 0x6f, 0x76, 0x65, 0x76, 0xc3, 0xa6, 0x72, 0x65, 0x6c, 0x73, 0x65, 0x74, 0x00(soveværelset)
type: PVS_TLV_TYPE_PRODUCT_ID (1), len: 5, val: 0x, 0x54, 0xff, 0x37, 0x81, 0x00
-----------------------------------
Item 2:
dsk: 0x, 0xA0, 0x45, 0x01, 0x02, 0xFE, 0xFF, 0x67, 0x98, 0xB0, 0x45, 0x06, 0x52, 0xFE, 0xFF, 0x67, 0x98
type: unknown type (254), len: 1, val: 0x, 0x00
type: PVS_TLV_TYPE_NAME (101), len: 10, val: 0x, 0x62, 0x6f, 0x72, 0x64, 0x6c, 0x61, 0x6d, 0x70, 0x65, 0x00(bordlampe)
type: PVS_TLV_TYPE_LOCATION (100), len: 18, val: 0x, 0x43, 0x6f, 0x6d, 0x6d, 0x6f, 0x64, 0x65, 0x20, 0x65, 0x6e, 0x20, 0x63, 0x68, 0xc3, 0xaa, 0x6e, 0x65, 0x00(Commode en chêne)
type: PVS_TLV_TYPE_PRODUCT_ID (1), len: 5, val: 0x, 0x54, 0xff, 0x37, 0x81, 0x00
-----------------------------------
Item 3:
dsk: 0x, 0xDD, 0x45, 0xFC, 0x2B, 0x27, 0x10, 0x85, 0xAB, 0xDC, 0x7D, 0xFB, 0xC7, 0x28, 0xA0, 0x86, 0x73
type: PVS_TLV_TYPE_LOCATION (100), len: 4, val: 0x, 0xe4, 0xbd, 0xa0, 0x00(你)
type: PVS_TLV_TYPE_PRODUCT_ID (1), len: 5, val: 0x, 0x54, 0xff, 0x37, 0x81, 0x01
-----------------------------------
Item 4:
dsk: 0x, 0x00, 0x05, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x27, 0x11, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83
type: PVS_TLV_TYPE_NAME (101), len: 4, val: 0x, 0xe4, 0xbd, 0xa0, 0x00(你)
type: PVS_TLV_TYPE_LOCATION (100), len: 22, val: 0x, 0x53, 0x6f, 0x6d, 0x6d, 0x65, 0x72, 0x68, 0x75, 0x73, 0x2c, 0x20, 0x27, 0x48, 0x6f, 0x72, 0x6e, 0x62, 0xc3, 0xa6, 0x6b, 0x27, 0x00(Sommerhus, 'Hornbæk')
-----------------------------------
Item 5:
dsk: 0x, 0x00, 0x06, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x27, 0x11, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83
type: PVS_TLV_TYPE_NAME (101), len: 7, val: 0x, 0x73, 0x65, 0x6e, 0x73, 0x6f, 0x72, 0x00(sensor)
type: PVS_TLV_TYPE_LOCATION (100), len: 17, val: 0x, 0xc2, 0xa9, 0x20, 0x53, 0x69, 0x67, 0x6d, 0x61, 0x20, 0x44, 0x65, 0x73, 0x69, 0x67, 0x6e, 0x73, 0x00(© Sigma Designs)
-----------------------------------
Item 6:
dsk: 0x, 0x00, 0x08, 0x7E, 0xB3, 0xD6, 0x6B, 0x87, 0x83, 0x00, 0x07, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83
type: PVS_TLV_TYPE_NAME (101), len: 28, val: 0x, 0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x2a, 0x6d, 0x69, 0x6e, 0x65, 0x2a, 0x21, 0x21, 0x20, 0x48, 0x61, 0x6e, 0x64, 0x73, 0x20, 0x6f, 0x66, 0x66, 0x2e, 0x00(This is *mine*!! Hands off.)
type: PVS_TLV_TYPE_LOCATION (100), len: 15, val: 0x, 0x42, 0xc3, 0xb8, 0x72, 0x6e, 0x65, 0x76, 0xc3, 0xa6, 0x72, 0x65, 0x6c, 0x73, 0x65, 0x00(Børneværelse)
-----------------------------------
Item 7:
dsk: 0x, 0x03, 0x19, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x03, 0x15, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83
type: PVS_TLV_TYPE_NAME (101), len: 255, val: 0x, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x00(01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123)
type: PVS_TLV_TYPE_LOCATION (100), len: 19, val: 0x, 0x53, 0x6f, 0x6d, 0x6d, 0x65, 0x72, 0x68, 0x75, 0x73, 0x20, 0x48, 0x6f, 0x72, 0x6e, 0x62, 0xc3, 0xa6, 0x6b, 0x00(Sommerhus Hornbæk)
-----------------------------------
Item 8:
dsk: 0x, 0xDB, 0x4D, 0xFC, 0x2B, 0x27, 0x10, 0x85, 0xAB, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2
type: PVS_TLV_TYPE_PRODUCT_ID (1), len: 5, val: 0x, 0x54, 0xff, 0x37, 0x81, 0x00
-----------------------------------
Item 9:
dsk: 0x, 0x00, 0x02, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2
type: PVS_TLV_TYPE_NAME (101), len: 7, val: 0x, 0x73, 0x65, 0x6e, 0x73, 0x6f, 0x72, 0x00(sensor)
type: PVS_TLV_TYPE_LOCATION (100), len: 20, val: 0x, 0x53, 0x6f, 0x6d, 0x6d, 0x65, 0x72, 0x68, 0x75, 0x73, 0x0a, 0x20, 0x48, 0x6f, 0x72, 0x6e, 0x62, 0xc3, 0xa6, 0x6b, 0x00(Sommerhus
 Hornbæk)
-----------------------------------
Item 10:
dsk: 0x, 0x00, 0x03, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2
type: PVS_TLV_TYPE_NAME (101), len: 7, val: 0x, 0x73, 0x65, 0x6e, 0x73, 0x6f, 0x72, 0x00(sensor)
type: PVS_TLV_TYPE_LOCATION (100), len: 20, val: 0x, 0x53, 0x6f, 0x6d, 0x6d, 0x65, 0x72, 0x68, 0x75, 0x73, 0x5c, 0x6e, 0x48, 0x6f, 0x72, 0x6e, 0x62, 0xc3, 0xa6, 0x6b, 0x00(Sommerhus\nHornbæk)
-----------------------------------
Item 11:
dsk: 0x, 0x06, 0xDE, 0xA0, 0x45, 0x01, 0x02, 0xFE, 0xFF, 0x67, 0x98, 0xF7, 0x8A, 0x9B, 0xD7, 0xC0, 0x18
type: PVS_TLV_TYPE_NAME (101), len: 11, val: 0x, 0x6c, 0x6f, 0x66, 0x74, 0x73, 0x6c, 0x61, 0x6d, 0x70, 0x65, 0x00(loftslampe)
type: PVS_TLV_TYPE_LOCATION (100), len: 17, val: 0x, 0x43, 0x68, 0x61, 0x6d, 0x62, 0x72, 0x65, 0x20, 0x64, 0x27, 0x49, 0x72, 0xc3, 0xa8, 0x6e, 0x65, 0x00(Chambre d'Irène)
type: PVS_TLV_TYPE_PRODUCT_ID (1), len: 5, val: 0x, 0x54, 0xff, 0x37, 0x81, 0x00
-----------------------------------
Item 12:
dsk: 0x, 0x00, 0x0E, 0x7E, 0xB3, 0xD6, 0x6B, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2
type: PVS_TLV_TYPE_NAME (101), len: 28, val: 0x, 0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x2a, 0x6d, 0x69, 0x6e, 0x65, 0x2a, 0x21, 0x21, 0x20, 0x48, 0x61, 0x6e, 0x64, 0x73, 0x20, 0x6f, 0x66, 0x66, 0x2e, 0x00(This is *mine*!! Hands off.)
type: PVS_TLV_TYPE_LOCATION (100), len: 15, val: 0x, 0x42, 0xc3, 0xb8, 0x72, 0x6e, 0x65, 0x76, 0xc3, 0xa6, 0x72, 0x65, 0x6c, 0x73, 0x65, 0x00(Børneværelse)
-----------------------------------
Item 13:
dsk: 0x, 0x03, 0x0C, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x18, 0xD2
type: PVS_TLV_TYPE_NAME (101), len: 254, val: 0x, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32, 0x00(0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012)
type: PVS_TLV_TYPE_LOCATION (100), len: 14, val: 0x, 0xe5, 0xaf, 0x8c, 0xe5, 0x8d, 0x8e, 0x20, 0xe9, 0xa5, 0xad, 0xe5, 0xba, 0x97, 0x00(富华 饭店)
Provisioning list storage:provisioning_list_store.dat
 */

uint8_t happy_dsks[14][16] = {{0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x07, 0x62, /* 0 */
                               0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x49, 0xD4},
                              {0xA0, 0x45, 0x01, 0x02, 0xFE, 0xFF, 0x67, 0x98, /* 1 */
                               0x7F, 0x69, 0x02, 0x4A, 0xD7, 0xBE, 0x87, 0x98},
                              {0xA0, 0x45, 0x01, 0x02, 0xFE, 0xFF, 0x67, 0x98, /* 2 */
                               0xB0, 0x45, 0x06, 0x52, 0xFE, 0xFF, 0x67, 0x98},
                              {0xDD, 0x45, 0xFC, 0x2B, 0x27, 0x10, 0x85, 0xAB, /* 3 */
                               0xDC, 0x7D, 0xFB, 0xC7, 0x28, 0xA0, 0x86, 0x73},
                              {0x00, 0x05, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x27, 0x11, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83}, //4
                              {0x00, 0x06, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x27, 0x11, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83}, //5
                              {0x00, 0x08, 0x7E, 0xB3, 0xD6, 0x6B, 0x87, 0x83, 0x00, 0x07, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83}, //6
                              {0x03, 0x19, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x03, 0x15, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83}, // 7
                              {0xDB, 0x4D, 0xFC, 0x2B, 0x27, 0x10, 0x85, 0xAB, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0xCA, 0xB2}, // 8
                              {0x00, 0x02, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x7C, 0x92}, // 9
                              {0x00, 0x03, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x43, 0x25}, //10
                              {0x06, 0xDE, 0xA0, 0x45, 0x01, 0x02, 0xFE, 0xFF, 0x67, 0x98, 0xF7, 0x8A, 0x9B, 0xD7, 0xC0, 0x18},
                              {0x00, 0x0E, 0x7E, 0xB3, 0xD6, 0x6B, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x43, 0x25}, // 12
                              {0x03, 0x0C, 0x7E, 0xB3, 0xD6, 0x6A, 0x87, 0x83, 0x30, 0x39, 0xFF, 0xFF, 0x00, 0x00, 0x07, 0x62}
};

static FILE *log_strm;

int main(void);


/* Test cases */
void test_device_import_basic();
void test_config_file_basic();


/* Actual tests */
/**
Test plan, basic import (happy cases).

The happy-case file contains 14 devices that are imported, then
validated against the constants in happy_dsks and happy_tlvs.
It is also used as sample file for the provisining list config.

DSK:
  - Hex format 2
  - QR format 0, 3

Mode:
  - Smart start 1, 2, 3
  - S2 0

TLVs
 - no tlv 0
 - one tlv 8
 - two tlvs 4
 - many tlvs 1, 2,
 - type 0 11
 - type 255 2
 - hex format 1 2
 - string format 1 2
 - empty string 2
 - newlines 9
 - escaped newline in utf (gives escaped newline)
 - tabs 7
 - spaces 4
 - utf-8 characters 3,4

General formatting
 - Comments
 - newlines
 - spaces
 - tabs
- no spaces

*/
void test_device_import_basic()
{
    static FILE *strm;
    int res = 0;
    uint8_t num_dev = 0;
    uint16_t ii;

    strm = fopen("../../../files/zipgateway_provisioning_list.cfg.template", "r");
    /* strm = fopen("../files/tlv-errors.cfg", "r"); */

    test_print(3, "Read in all the happy cases from the happy-case file\n");

    if (strm) {
        res = pvs_parse_config_file(strm);
        printf("Stopping with code %d\n", res);
        fclose(strm);
    } else {
        printf("Failed to open file.\n");
    }

    /* Happy validation: Check that we do not crash while running through it */
    provisioning_list_print();

    test_print(3, "Now validate the read-in values\n");
    test_print(3, "First the total number of devices\n");
    num_dev = provisioning_list_get_count();
    check_true(num_dev == 14, "Import 14 devices");

    for (ii = 0; ii < num_dev; ii++)
    {
        uint8_t *dsk = happy_dsks[ii];
        struct provision *pvs = provisioning_list_dev_get(16, dsk);

        check_device(pvs, ii);
    }

    provisioning_list_clear();
}

void test_config_file_basic()
{
/* Basic file:
 - Empty file
 - File with one device
 - File with many devices
 - File with max devices (232)

Interaction with storage file:
 - Storage file is NULL, but default file exists (should NOT read config file).
 - Storage file is not null,
  a) storage file does not exist, default file exists (should read config file and overwrite storage).
  b) Storage file exists (should NOT read config file).
- Storage file is not readable.
*/
    uint8_t dskone[16] = {0x30, 0x39, 0xff, 0xff, 0x00, 0x00, 0xa3, 0xa2, 0x30, 0x39, 0xff, 0xff, 0x00, 0x00, 0xa3, 0xa2};

    start_case("Empty file", NULL);
    provisioning_list_clear();
    steal_file(PROVISIONING_LIST_STORE_FILENAME_DEFAULT, "pvs_dummy.dat");
    provisioning_list_init(NULL, "../../../test/pvs/files/pvs_empty.cfg");
    // TODO: how do I know it was read?
    check_zero(provisioning_list_get_count(), "Import nothing from empty config file.");
    close_case("Empty file");

    start_case("File with one device", NULL);
    provisioning_list_clear();
    steal_file(PROVISIONING_LIST_STORE_FILENAME_DEFAULT, "pvs_dummy.dat");
    provisioning_list_init(NULL, "../../../test/pvs/files/pvs_one.cfg");
    check_true(provisioning_list_get_count() == 1, "Import one device from config file.");
    provisioning_list_dev_remove(16, dskone);
    check_true(provisioning_list_get_count() == 0, "Import correct device from config file.");
    provisioning_list_clear();
    close_case("File with one device");

    start_case("File with many devices", NULL);
    provisioning_list_clear();
    steal_file(PROVISIONING_LIST_STORE_FILENAME_DEFAULT, "pvs_dummy.dat");
    provisioning_list_init(NULL, "../../../test/pvs/files/pvs_many.cfg");
    check_true(provisioning_list_get_count() == 20, "Import 20 devices from config file.");
    close_case("File with many devices");

    start_case("File with 232 devices", NULL);
    provisioning_list_clear();
    steal_file(PROVISIONING_LIST_STORE_FILENAME_DEFAULT, "pvs_dummy.dat");
    provisioning_list_init(NULL, "../../../test/pvs/files/pvs_max.cfg");
    check_true(provisioning_list_get_count() == 232, "Import 232 device from config file.");
    provisioning_list_clear();
    close_case("File with 232 devices");

    start_case("Storage file argument is NULL, but default file exists (should NOT read config file).", NULL);
    provisioning_list_init(NULL, NULL); /* write to default */
    provisioning_list_init(NULL, "../../../test/pvs/files/pvs_many.cfg");
    check_zero(provisioning_list_get_count(),
               "Do not import from config file when storage file exists.");
    provisioning_list_clear(); /* write to default */
    close_case("Storage file argument is NULL, but default file exists (should NOT read config file).");

    start_case("Storage file argument is not NULL", NULL);

    test_print(3, "Part A: file does not exist, but default file exists\n (should read config file and overwrite storage).\n");
    steal_file("pvs-newstorage.dat", "pvs_dummy.dat"); /* Make sure alternate storage does not exist */
    provisioning_list_clear(); /* write to storage */
    provisioning_list_init("pvs-newstorage.dat", "../../../test/pvs/files/pvs_many.cfg");
    check_true(provisioning_list_get_count() == 20,
               "Import from config file when default storage exists but gw uses another storage file, which does not exist.");
    check_file_exists("pvs-newstorage.dat",
                      "Use new storage file.");

    test_print(3, "Part B: File exists\n");
    provisioning_list_clear(); /* write to storage */
    provisioning_list_init("pvs-newstorage.dat", "../../../test/pvs/files/pvs_one.cfg");
    check_true(provisioning_list_get_count() == 0, "Do not import from config file when storage file exists.");

    close_case("Storage file argument is not NULL");

    provisioning_list_clear(); /* write to storage */
//    start_case("Storage file is not readable.", NULL);
//    close_case("Storage file is not readable.");

}

/** Note that this test uses relative file paths */
int main(void)
{
    verbosity = test_case_start_stop;

    log_strm = test_create_log(TEST_CREATE_LOG_NAME);

    provisioning_list_init(NULL, NULL);

    provisioning_list_clear();

    test_device_import_basic();

    provisioning_list_clear(); /* write to storage */

    test_config_file_basic();

    provisioning_list_clear();

    close_run();

    fclose(log_strm);

    return numErrs;
}
